- name: Fetch food from Strapi
  env:
    STRAPI_URL: ${{ secrets.STRAPI_URL }}
    STRAPI_TOKEN: ${{ secrets.STRAPI_TOKEN }}
  run: |
    node -e '
    import fetch from "node-fetch";
    import fs from "fs";

    const url = `${process.env.STRAPI_URL}/api/foods?populate=photo`;
    const headers = { Authorization: `Bearer ${process.env.STRAPI_TOKEN}` };

    const res = await fetch(url, { headers });
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);

    const data = await res.json();

    const foods = (data.data || []).map(item => {
      const attrs = item.attributes || {};
      return {
        id: item.id,
        name: attrs.name || "",
        amount: attrs.amount || 0,
        price: attrs.price || 0,
        shop: attrs.shop || "",
        todate: attrs.todate || "",
        photo: (attrs.photo?.data || []).map(p => p.attributes?.url || ""),
        photoHash: attrs.photoHash || ""
      };
    });

    fs.writeFileSync("food.json", JSON.stringify(foods, null, 2));
    console.log("food.json generated successfully");
    '
