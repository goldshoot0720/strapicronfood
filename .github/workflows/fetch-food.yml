name: Fetch Strapi Food  # workflow 名稱

on:
  schedule:
    - cron: "*/55 * * * *"  # 每55分鐘執行
  workflow_dispatch:        # 手動也能觸發

jobs:
  fetch-food:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install node-fetch
        run: npm install node-fetch@3

      - name: Fetch food from Strapi
        env:
          STRAPI_URL: ${{ secrets.STRAPI_URL }}
          STRAPI_TOKEN: ${{ secrets.STRAPI_TOKEN }}
        run: |
          node -e '
          import fetch from "node-fetch";
          import fs from "fs";

          const url = `${process.env.STRAPI_URL}/api/foods?populate=photo`;
          const headers = { Authorization: `Bearer ${process.env.STRAPI_TOKEN}` };

          const res = await fetch(url, { headers });
          if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);

          const data = await res.json();

          const foods = (data.data || []).map(item => {
            const attrs = item.attributes || {};
            return {
              id: item.id,
              name: attrs.name || "",
              amount: attrs.amount || 0,
              price: attrs.price || 0,
              shop: attrs.shop || "",
              todate: attrs.todate || "",
              photo: (attrs.photo?.data || []).map(p => p.attributes?.url || ""),
              photoHash: attrs.photoHash || ""
            };
          });

          fs.writeFileSync("food.json", JSON.stringify(foods, null, 2));
          console.log("food.json generated successfully");
          '

      - name: Commit & push food.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add food.json
          git commit -m "Update food.json"
          git push
        continue-on-error: true
