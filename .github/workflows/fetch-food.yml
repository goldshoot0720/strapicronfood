name: Fetch Strapi Food

on:
  schedule:
    # 這裡保留你的設定，如果是想每5分鐘跑一次，請改成 "*/5 * * * *"
    - cron: "*/55 * * * *"
  workflow_dispatch:

# 賦予寫入權限，這對 git push 很重要
permissions:
  contents: write

jobs:
  fetch-food:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install node-fetch
        run: npm install node-fetch@3

      - name: Fetch food from Strapi
        env:
          STRAPI_URL: ${{ secrets.STRAPI_URL }}
          STRAPI_TOKEN: ${{ secrets.STRAPI_TOKEN }}
        # 關鍵修正：加入 --input-type=module 以支援 import 和 top-level await
        run: |
          node --input-type=module -e '
          import fetch from "node-fetch";
          import fs from "fs";

          const url = `${process.env.STRAPI_URL}/api/foods?populate=photo`;
          const headers = { Authorization: `Bearer ${process.env.STRAPI_TOKEN}` };

          console.log("Fetching from:", url);

          try {
            const res = await fetch(url, { headers });
            if (!res.ok) throw new Error(`Fetch failed: ${res.status} ${res.statusText}`);

            const data = await res.json();
            
            const foods = (data.data || []).map(item => {
              const attrs = item.attributes || {};
              return {
                id: item.id,
                name: attrs.name || "",
                amount: attrs.amount || 0,
                price: attrs.price || 0,
                shop: attrs.shop || "",
                todate: attrs.todate || "",
                // 這裡加入了 safety check 防止 map 出錯
                photo: Array.isArray(attrs.photo?.data) 
                  ? attrs.photo.data.map(p => p.attributes?.url || "") 
                  : [],
                photoHash: attrs.photoHash || ""
              };
            });

            fs.writeFileSync("food.json", JSON.stringify(foods, null, 2));
            console.log("food.json generated successfully with " + foods.length + " items.");
          } catch (error) {
            console.error("Error executing script:", error);
            process.exit(1);
          }
          '

      - name: Commit & push food.json
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          
          # 檢查是否有檔案變更，有變更才 commit，避免 error
          if [[ -n $(git status -s food.json) ]]; then
            git add food.json
            git commit -m "Update food.json [skip ci]"
            git push
            console.log("Changes pushed to repository.");
          else
            echo "No changes in food.json, skipping commit."
          fi
